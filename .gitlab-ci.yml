image: node:latest

before_script:
  - npm i -g firebase-tools

stages:     # List of stages for jobs, and their order of execution
  - npm
  - lint
  - test
  - deploy

npm-functions:
  stage: npm
  script:
    - cd functions
    - echo "Running npm install"
    - npm install
    - echo "npm install is complete"
    - cd ..
  cache:
    paths:
      - functions/node_modules/
  artifacts:
    expire_in: 1 days
    when: on_success
    paths:
      - functions/node_modules/

eslint-backend:
  stage: lint
  dependencies: 
    - npm-functions
  script:
    # Install ESLint in this docker container
    - npm install -g eslint
    # Configure ESLint (will read your .eslintrc file)
    - cd functions
    - echo "Running eslint on all files in functions/"
    - npx eslint --print-config index.js
    - echo "Eslint is done"

unit-test-backend:
  stage: test
  dependencies:
    - npm-functions
  script:
    - cd functions
    - echo "Running unit tests"
    - npm run test
    - echo "Unit tests are complete"
    - cd ..

deploy-firestore:
  stage: deploy
  script:
    - echo "Deploying firestore..."
    - firebase deploy --only firestore --token $FIREBASE_TOKEN
    - echo "Firestore successfully deployed."
  only:
    refs:
      - main
    changes:
      - firestore.rules
      - firestore.indexes.json

deploy-functions:   # This job runs in the deploy stage.
  stage: deploy     # It only runs when *both* jobs in the test stage complete successfully.
  script:
    - echo "Deploying functions..."
    - cd functions
    - npm install
    - cd ..
    - firebase deploy --only functions --token $FIREBASE_TOKEN
    - echo "Functions successfully deployed."
  only:
    refs:
      - main
    changes:
      - functions/**/*

deploy-hosting:
  stage: deploy
  script:
    - yarn
    - echo "Building application"
    - yarn build
    - echo "Building is done"
    - echo "Starting to deploy application"
    - firebase deploy --only hosting --token $FIREBASE_TOKEN
    - echo "Application is deployed"
  only:
    - main