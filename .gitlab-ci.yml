image: node:latest

before_script:
  - npm i -g firebase-tools

stages:     # List of stages for jobs, and their order of execution
  - npm
  - lint
  - test
  - deploy

npm-functions:
  stage: npm
  script:
    - cd functions
    - echo "Running npm install"
    - npm install
    - echo "npm install is complete"
    - cd ..
  cache:
    paths:
      - functions/node_modules/
  artifacts:
    expire_in: 1 days
    when: on_success
    paths:
      - functions/node_modules/

eslint-backend:
  stage: lint
  dependencies: 
    - npm-functions
  script:
    # Install ESLint in this docker container
    - npm install -g eslint
    # Configure ESLint (will read your .eslintrc file)
    - cd functions
    - echo "Running eslint on functions/index.js"
    - npx eslint -config ~/functions/.eslintrc.js index.js
    - echo "Eslint for index.js is done"
    
    - echo "Running eslint on functions/databaseSchemas.js"
    - npx eslint -config ~/functions/.eslintrc.js databaseSchemas.js
    - echo "Eslint for databaseSchemas.js is done"

    - echo "Running eslint on functions/firestoreClient.js"
    - npx eslint -config ~/functions/.eslintrc.js firestoreClient.js
    - echo "Eslint for firestoreClient.js is done"
    - echo "Eslint check for backend is now complete"
    - cd ..

unit-test-backend:
  stage: test
  dependencies:
    - npm-functions
  script:
    - cd functions
    - echo "Running unit tests"
    - npm run test
    - echo "Unit tests are complete"
    - cd ..

deploy-firestore:
  stage: deploy
  script:
    - echo "Deploying firestore..."
    - firebase deploy --only firestore --token $FIREBASE_TOKEN
    - echo "Firestore successfully deployed."
  only:
    refs:
      - main
    changes:
      - firestore.rules
      - firestore.indexes.json

deploy-functions:   # This job runs in the deploy stage.
  stage: deploy     # It only runs when *both* jobs in the test stage complete successfully.
  script:
    - echo "Deploying functions..."
    - cd functions
    - npm install
    - cd ..
    - firebase deploy --only functions --token $FIREBASE_TOKEN
    - echo "Functions successfully deployed."
  only:
    refs:
      - main
    changes:
      - functions/**/*

deploy-hosting:
  stage: deploy
  script:
    - yarn
    - echo "Building application"
    - yarn build
    - echo "Building is done"
    - echo "Starting to deploy application"
    - firebase deploy --only hosting --token $FIREBASE_TOKEN
    - echo "Application is deployed"
  only:
    refs:
      - main
    changes:
      - app/traste/**/*